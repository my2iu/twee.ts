<!doctype html>
<html>
	<head>
		<script src="lib/jquery-1.11.3.min.js"></script>
		<script src="lib/typescript-1.5beta.js"></script>
		<script src="lib/marked.js"></script>
		<script>
			"use strict";
			var importer = {
				importedCount : 1,
				importDone : null,
				decrementImportedCount : function() {
					this.importedCount--;
					if (this.importDone != null && this.importedCount == 0)
						this.importDone();
				},
				onImportDone : function(fn) {
					this.importDone = fn;
					this.decrementImportedCount();
				},
				importScriptFile : function(fileName, type) {
					this.importedCount++;
					var parent = this;
					$.get(fileName, function(data) {
						var s = $('<script><' + '/script>')
							.attr('type', type)
							.attr('filename', fileName)
							.text(data);
						$('head').append(s);
						parent.decrementImportedCount();
					});
				},
				importTweeTs : function(fileName) {
					this.importScriptFile(fileName, 'twee.ts');
				},
				importTsSrc : function (fileName) {
					this.importScriptFile(fileName, 'typescript');
				}
			};
		</script>
		<script>
			function compileTs(files, errorReporter)
			{
				"use strict";
				var compilerHost = {
					getSourceFile: function(fileName, langVersion) {
						var s = $("script[type='typescript'][filename='" + fileName + "']").first();
						return ts.createSourceFile(fileName, s.text(), langVersion);
					},
					getDefaultLibFileName : function(options) {
						return "lib/lib.d-1.5beta.ts";
					},
					writeFile : function(fileName, data, bom) {
						var s = $('<script><' + '/script>').text(data).attr('filename', fileName);
						// Append a filename comment at the end so that Chrome will show
						// the file in the debugger
						s.append('\n//@ sourceURL=' + fileName);
						$('head').append(s);
					},
					getCurrentDirectory : function() {
						return '';
					},
					getCanonicalFileName : function(fileName) {
						return fileName;
					},
					useCaseSensitiveFileNames : function() {
						return true;
					},
					getNewLine : function() {
						return '\n';
					}
				};
				var tsCompilation = ts.createProgram(files,
					{noEmitOnError: true, noImplicitAny: false,
					target: ts.ScriptTarget.ES5,
					module: ts.ModuleKind.CommonJS,
					out: 'transpiled.js'},
					compilerHost);
				var result = tsCompilation.emit();
				result.diagnostics = ts.getPreEmitDiagnostics(tsCompilation).concat(result.diagnostics);
				return result;
			}
		</script>
		<script>
			var tweeTsToTs = {
				passageNames : [],
				compile : function () {
					var untitledCount = 0;
					var parent = this;
					var scripts = $("script[type='twee.ts']")
					//	.filter(function(idx, el) { return $.inArray(el.getAttribute('filename'), files); });
						.each(function(idx, el) {
							var fileName = el.getAttribute('filename');
							if (!fileName) 
							{
								untitledCount++;
								fileName = '_' + untitledCount;
							}
							var s = $('<script><' + '/script>')
								.attr('type', 'typescript')
								.attr('filename', fileName + '.ts');
							$('head').append(s);
							parent.tweeTsLex(el.textContent, s);
						});
				},
				tweeTsLex : function(text, outputElement)
				{
					var pos = 0;
					var passageLine = null;
					var passageText = '';
					// TODO: some scheme to allow for comments that span across passages so that
					//    you can easily comment out passages
					while(true) {
						var newLine = text.indexOf("\n", pos);
						var line = (newLine < 0 ? text.substring(pos) : text.substring(pos, newLine + 1));
						
						if (line.trim().indexOf("::") == 0)
						{
							this.handlePassage(passageLine, passageText, outputElement);
							passageLine = line;
							passageText = '';
						}
						else
						{
							passageText += line;
						}
						
						if (newLine < 0) break;
						pos = newLine + 1;
					}
					this.handlePassage(passageLine, passageText, outputElement);
					
				},
				handlePassage : function(passageLine, passage, outputElement) {
					// Parse the name of the passage and its tags
					if (passageLine == null) return;
					var match = /\s*::\s*(\S[^\[]*)(.*)/.exec(passageLine);
					if (!match) return;
					var passageName = match[1].trim();
					var tags = [];
					var rest = match[2];
					var tagRegex = /\s*\[([^\]]*)\](.*)/;
					match = tagRegex.exec(rest);
					while (match)
					{
						tags.push(match[1]);
						rest = match[2];
						match = tagRegex.exec(rest);
					}
					
					function strEscape(str) { return str.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n"\n+"').replace(/\r/g, '\\r'); }
					var substituted = '';
					var pos = 0;
					
					// Match whitespace at the beginning so that we can trim it from the Markdown output 
					// (but we preserve the lines in the output to ensure that line numbers approximately match)
					var whitespaceRegex = /\s*/g;
					match = whitespaceRegex.exec(passage);
					pos = whitespaceRegex.lastIndex;
					for (var n = 0; n < match[0].split("\n").length - 1; n++) substituted += '\n';
					
					// Do the templating stuff
					substituted += 'var _$_ = ""; _$_ += "';
					
					var templateRegex = /<%(.*?)%>/g;
					templateRegex.lastIndex = pos;
					match = templateRegex.exec(passage);
					while (match != null) {
						substituted += strEscape(passage.substring(pos, match.index));
						var contents = match[1];
						if (contents.length > 0 && contents.charAt(0) == '=') {
							if (contents.length > 1 && contents.charAt(1) == '=')  {
								substituted += '" + (' + contents.substring(2) + ') + "';
							} else {
								substituted += '" + htmlEscape(' + contents.substring(1) + ') + "';
							}
						} else {
							substituted += '"; ' + contents + ';_$_ += "';
						}
						pos = templateRegex.lastIndex;
						match = templateRegex.exec(passage);
					}
					// Trim whitespace at the end from the Markdown output 
					// (but we preserve the lines in the output to ensure that line numbers approximately match)
					var whitespaceEndRegex = /(.*?)(\s*)$/g;
					whitespaceEndRegex.lastIndex = pos;
					match = whitespaceEndRegex.exec(passage);
					substituted += strEscape(match[1]) + '";';
					for (var n = 0; n < match[2].split("\n").length - 2; n++) substituted += '\n';
					
					var passageCode =  'passages.push(new Passage("' + strEscape(passageName)+ '", '
						+ '"' + strEscape(passageName) + '", '
						+ 'function() {\n'
						+ substituted
						+ '; return _$_;}));\n';
						
					this.passageNames.push(passageName);
					outputElement.append(document.createTextNode(passageCode));
					
//					console.log(passageName);
//					console.log(tags);
//					console.log(substituted);
				}
			};
		</script>
		
		<script>
			importer.importTsSrc('lib/lib.d-1.5beta.ts');
			importer.importTsSrc('lib/jquery.d.ts');
			importer.importTsSrc('lib/runtime.ts');
			$(document).ready(function() {
				importer.onImportDone(function() {
					tweeTsToTs.compile();
					
					// Gather all the typescript files for compilation
					var tsFiles = $("script[type='typescript']").map(
						function(idx, el) {return el.getAttribute('filename');});
					var result = compileTs(tsFiles);
					for (var n = 0; n < result.diagnostics.length; n++)
					{
						var diagnostic = result.diagnostics[n];
						var lineChar = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
						var message = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
						var messageLine = diagnostic.file.fileName +  ' (' + (lineChar.line + 1) + ':' + (lineChar.character + 1) + '): ' + message; 
						if (result.emitSkipped) {
							// Log errors right to the main window
							$('#passage').append($("<div>").text(messageLine));
						} else {
							// We were able to compile successfully, so just log warnings to console
							console.log(messageLine);
						}
					}
				});
			});
		</script>
		
<script type="twee.ts">

					:: Passage1 [start] [SomeOtherTag]
					<% var b = 'John'; %>
					Hello, how are you, <%=b%>?

					:: Passage2

					2nd passage
					</script>
					<script type="twee.ts">
					::Start
					This is where things start
					
					[[Go to first passage -> Passage1]]
					</script>		
<script type="typescript" filename="_.ts">
// You can put Typescript code for initializing your game directly here (or in external Typescript files)

</script>
	</head>
	<body>
	<div id="passage">
	</div>
	</body>
</html>